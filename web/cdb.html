<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8"/>
  <title>Can-Digital-Bahn Device Detection</title>
  <style>
    html {background-color:#eeeeee}
    body {
        background-color:#ccffcc;
        font-family:Tahoma,Arial,Helvetica,sans-serif;
        font-size:12px;
        margin-left:15%;
        margin-right:15%;
        border:3px groove #006600;
        padding:15px
    }
    h1   {
        text-align:left;
        font-size:1.5em;
        font-weight:bold
    }
  </style>
  <!-- include the jquery.jmri library and its dependencies -->
  <script src="/js/jquery-2.2.4.min.js"></script>
  <script src="/js/json2.js"></script>
  <script src="/js/jquery.websocket.js"></script>
  <script src="/js/logger.js"></script>
  <script src="/js/jquery.jmri.js"></script>
  <script type="text/javascript">
    var jmri = null;

    //append a new row to the table, or replace an existing row, based on name
    function setRow(name, data){
      var tbody = $("table#memories tbody").html(); //get current table body
      var tds = "<td>" + data.name + "</td><td>" + data.userName + "</td><td>" //build cells
          + data.value + "</td><td>" + data.comment + "</td>";
      var tr = "<tr data-name='" + data.name + "'>" + tds + "</tr>"; //build row with key
      var row = $("table#memories tr[data-name='" + name + "']"); //look for row by key
      if ($(row).length) {
          row.html(tds); //if found, replace cells
      } else {
          $("table#memories tbody").html(tbody + tr); //if not found, append row to table body
      }
    };

    /**
     * List system connections relevant to CdB
     */
    function setSystemConnectionOptions(name, data){
      let relevantVendors = ["CAN-digital-Bahn", "Marklin"];
      // Don't list irrelevant connections
      if (!relevantVendors.includes(data.mfg)) {
          return;
      }
      let selectElt = document.getElementById('system_connection_selection');
      // Check if we already have such an option that can be replaced
      let optionElt = document.querySelector("select#system_connection_selection option[value=" + data.name + "]");
      if (optionElt == null) {
          optionElt = document.createElement("option");
          selectElt.appendChild(optionElt);
      }
      optionElt.textContent = data.name + ": " + data.prefix + ": " + data.description;
      optionElt.value = data.name;
    };



    $(document).ready(function () {
        // once the document is loaded, assign a $.JMRI object to
        // the jmri variable and overload the function turnout(name, state, data)
        jmri = $.JMRI({
            // when the JMRI websocket has completed initialization, call this
            hello: function (data) {
                jmri.log("in hello: data=" + JSON.stringify(data).substr(0, 180) + "...");
                jmri.getList("memories");
                jmri.getList("systemConnections");
            },
            // when the JMRI object receives an array of memories, call this
            memories: function (data) {
                data.forEach(el => {
                    jmri.getObject(el.type, el.data.name);
                });
                //empty the body of the table
                $("table#memories tbody").html("");
            },
            // when the JMRI object receives a memory update, call this
            memory: function (name, state, data) {
                setRow(name, data); // add or update the row
            },
            // Catch system connections
            systemConnections: function (data) {
                jmri.log("in connections: data=" + JSON.stringify(data).substr(0, 180) + "...");
                data.forEach(el => {
                    jmri.log("Requesting update listener for " + el.type +" '" + el.data.name +"'");
                    jmri.getObject(el.type, el.data.name);
                });
                //empty the body of the table
                $("table#systemConnections tbody").html("");
            },
            // when the JMRI object receives a memory update, call this
            systemConnection: function (name, data) {
                jmri.log("in systemConnection: name='" + name + "', data="
                    + JSON.stringify(data).substr(0, 180) + "...");
                setSystemConnectionOptions(name, data); // add or update the row
            },


            // all messages call console(), so use it for debugging
            console: function (originalData) {
                var data = JSON.parse(originalData);
                jmri.log("in console: data=" + JSON.stringify(data).substr(0, 180) + "...");
            }
        });

        // trigger the initial connection to the JMRI server
        jmri.connect();

        // Register handler for scan button
        let scanButtonElt = document.getElementById("scan_cdb_components");
        let connectionSelectElt = document.getElementById("system_connection_selection");
        scanButtonElt.onclick = function(e) {
            jmri.log("Requested scanning CAN bus for " + connectionSelectElt.value);
        };

        // Register handler for selecting a connection
        scanButtonElt.disabled = true;
        connectionSelectElt.onchange = function() {
          if (connectionSelectElt.value == "none") {
              scanButtonElt.disabled = true;
          } else {
              scanButtonElt.disabled = false;
          }
        };
    });
  </script>

</head>
<body>
<h1>Can-Digital-Bahn Device Detection</h1>
<hr/>
<h2>Memories Connections</h2>

<div class="container">
  <table id="memories" class="table-striped table-hover table-responsive">
    <thead>
    <tr>
      <th>System Name</th>
      <th>User Name</th>
      <th>Value</th>
      <th>Comment</th>
    </tr>
    </thead>
    <tbody>
    <td>S</td>
    <td>U</td>
    <td>V</td>
    <td>C</td> <!-- this will be cleared and replaced -->
    </tbody>
  </table>
  <hr/>
  <h2>System Connections</h2>
  Select a connection:
  <select id="system_connection_selection">
    <option value="none">Select a CdB or Marklin system connection:</option>
  </select>
  <button id="scan_cdb_components">Scan for components</button>
</div><!-- /container -->

</body>
</html>
